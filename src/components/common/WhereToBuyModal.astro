œ---
// src/components/common/WhereToBuyModal.astro
import { t, type Locale } from '../../i18n/i18n';

interface Props {
  currentLang: Locale;
}

const { currentLang } = Astro.props;

interface Stockist {
  id: string;
  name: string;
  icon: string;
  link: string;
}

// Obtener los stockists desde las traducciones
const stockists = t('stockist', { namespace: 'products', locale: currentLang as Locale }) || [];
---

<!-- Where to buy modal -->
<div
  id="where-to-buy-modal"
  class="fixed inset-0 z-[2147483646] hidden"
  aria-hidden="true"
>
  <div class="absolute inset-0 bg-black/60" data-wtb-backdrop></div>

  <div class="absolute inset-0 flex items-center justify-center p-4 sm:p-6">
    <div class="w-full max-w-3xl bg-white rounded-[28px] shadow-2xl overflow-hidden">
      <div class="flex items-center justify-between px-6 py-5 border-b border-black/10">
        <h3 class="font-title text-2xl md:text-3xl font-bold italic text-black">
          {currentLang === 'es' ? 'Compra en delivery' : 'Order for delivery'}
        </h3>
        <button
          type="button"
          class="w-10 h-10 rounded-full bg-primaryCream text-black flex items-center justify-center hover:opacity-80 transition"
          aria-label={currentLang === 'es' ? 'Cerrar' : 'Close'}
          data-wtb-close
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 6 6 18" />
            <path d="M6 6 18 18" />
          </svg>
        </button>
      </div>

      <div class="p-6 sm:p-8">
        {Array.isArray(stockists) && stockists.length > 0 ? (
          <div class="flex items-center justify-center gap-4 sm:gap-6 flex-wrap">
            {stockists.map((s: Stockist) => (
              <a
                href={s.link}
                target="_blank"
                rel="noopener noreferrer"
                class="group rounded-2xl bg-primaryCream p-4 sm:p-5 flex flex-col items-center justify-center text-center hover:opacity-90 transition w-full sm:w-[200px]"
              >
                <div class="bg-white rounded-2xl w-full flex items-center justify-center p-4 sm:p-5 min-h-[120px]">
                  <img
                    src={s.icon}
                    alt={s.name}
                    class="max-h-[80px] w-auto object-contain"
                    loading="eager"
                    fetchpriority="high"
                    decoding="sync"
                  />
                </div>
                <div class="mt-3 font-bold text-black text-sm sm:text-base">{s.name}</div>
              </a>
            ))}
          </div>
        ) : (
          <div class="text-center text-black/70">
            {currentLang === 'es'
              ? 'No hay opciones de delivery disponibles por el momento.'
              : 'No delivery options are available at the moment.'}
          </div>
        )}
      </div>
    </div>
  </div>
</div>

<script is:inline>
  (function () {
    function initWhereToBuyModal() {
      const modal = document.getElementById('where-to-buy-modal');
      if (!(modal instanceof HTMLElement)) return;

      if (modal.dataset.wtbInit === '1') return;
      modal.dataset.wtbInit = '1';

      const closeBtn = modal.querySelector('[data-wtb-close]');
      const backdrop = modal.querySelector('[data-wtb-backdrop]');

      const open = () => {
        modal.classList.remove('hidden');
        modal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
        
        // Forzar recarga de imágenes del modal
        setTimeout(() => {
          const modalImages = modal.querySelectorAll('img');
          modalImages.forEach(img => {
            if (!img.complete || img.naturalHeight === 0) {
              console.log('Reloading image:', img.src);
              const src = img.src;
              img.src = '';
              img.src = src;
            }
          });
        }, 100);
      };

      const close = () => {
        modal.classList.add('hidden');
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
      };

      // Exponer función global para abrir el modal
      window.openWhereToBuyModal = open;

      if (closeBtn) closeBtn.addEventListener('click', close);
      if (backdrop) backdrop.addEventListener('click', close);

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') close();
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initWhereToBuyModal);
    } else {
      initWhereToBuyModal();
    }

    document.addEventListener('astro:page-load', initWhereToBuyModal);
  })();
</script>
