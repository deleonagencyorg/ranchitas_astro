---
import { getLocale } from '../../i18n/i18n';

const currentLang = getLocale();

interface Recipe {
  id: string;
  title: string;
  image: string;
  hover_image?: string;
  preparation_time: number;
  category?: string;
  category_en?: string;
  categories?: string[];
  categories_en?: string[];
  difficulty?: string;
  servings?: number;
  rating?: number;
  description?: string;
}

export interface Props {
  title?: string;
  subtitle?: string;
  description?: string;
  textButton?: string;
  items?: any[];
  detail?: boolean;
}

const {
  title = currentLang === 'es' ? 'Recetas' : 'Recipes',
  subtitle = currentLang === 'es' ? 'Descubre nuevas recetas' : 'Discover new recipes',
  description = currentLang === 'es' 
    ? 'Fusiona sabores universales y el cronch de Ranchitas, con estas opciones deliciosas y fáciles de preparar.'
    : 'Combine universal flavors and the crunch of Ranchitas with these delicious and easy-to-prepare options.',
  textButton = currentLang === 'es' ? 'Descubrir más' : 'Discover more',
  items,
  detail = false
} = Astro.props;

let recipeItems: Recipe[] = Array.isArray(items) ? (items as unknown as Recipe[]) : [];
if (!recipeItems.length) {
  const recipeModules = import.meta.glob<{ default: Recipe }>("../../locales/*/recipes/*.json");
  for (const path in recipeModules) {
    const lang = path.split('/')[3];
    if (lang === currentLang) {
      const mod = await recipeModules[path]();
      recipeItems.push(mod.default);
    }
  }
}
---

<section class="w-full py-8 sm:py-12 overflow-hidden">
  <div class="max-w-[1600px] mx-auto px-3 sm:px-4 md:px-8">
    <div class="flex flex-col lg:flex-row gap-6 sm:gap-8 items-center">
      
      <!-- Lado izquierdo - Contenido de texto -->
      <div class="w-full lg:w-1/3 space-y-4 sm:space-y-6">
        <!-- Badge verde -->
        <div class="inline-block">
          <span class=`font-mohave font-bold text-[16px] sm:text-[20px] ${detail ? 'text-[#F86509]' : 'text-[#7FBB00]'} uppercase leading-none tracking-normal`>
            {title}
          </span>
        </div>

        <!-- Título principal -->
        <h2 class=`text-[32px] sm:text-[40px] md:text-5xl lg:text-6xl font-bold ${detail ? 'text-white' : 'text-black'}  leading-none`>
          {subtitle}
        </h2>

        <!-- Descripción -->
        <p class=`${detail ? 'text-white' : 'text-gray-700'}  text-sm sm:text-base md:text-lg`>
          {description}
        </p>

        <!-- Botón -->
        <a 
          href={`/${currentLang}/${currentLang === 'es' ? 'recetas' : 'recipes'}`}
          class=`md:inline-block lg:inline-block hidden ${detail ? 'bg-[#F86509] ' : 'bg-[#84BC00] '}  text-white py-[10px] px-[60px] rounded-full font-bold text-lg hover:bg-[#6da000] transition-colors`
        >
          {textButton}
        </a>
        <a 
          href={`/${currentLang}/${currentLang === 'es' ? 'recetas' : 'recipes'}`}
          class=`md:hidden lg:hidden inline-block ${detail ? 'bg-[#F86509] ' : 'bg-[#84BC00] '}  text-white w-full flex p-[10px] items-center justify-center rounded-full font-bold text-lg hover:bg-[#6da000] transition-colors`
        >
          {textButton}
        </a>
      </div>

      <!-- Lado derecho - Carrusel de recetas -->
      <div class="w-full lg:w-2/3" data-recipes-carousel>
        <div class="recipes-carousel relative overflow-hidden">
          <div class="recipes-carousel-container overflow-hidden">
            <div 
              class="recipes-carousel-track flex gap-6 transition-transform duration-500 ease-in-out" 
              id="recipesTrack"
            >
              {recipeItems.map((recipe, index) => (
                <div 
                  class="recipe-slide flex-shrink-0 w-full md:w-[calc(50%-12px)]"
                  data-index={index}
                >
                  <a 
                    href={`/${currentLang}/${currentLang === 'es' ? 'recetas' : 'recipes'}/${recipe.id}`}
                    class={`block ${detail ? 'bg-[#F86509] ' : 'bg-[#84BC00] '} rounded-[15px] sm:rounded-[20px] overflow-hidden shadow-xl hover:shadow-2xl transition-shadow h-full`}
                  >
                    <!-- Imagen -->
                    <div class="p-4 sm:p-6 pb-0">
                      <img 
                        src={recipe.image || '/images/recipes/placeholder.jpg'}
                        alt={recipe.title}
                        class="w-full h-[200px] sm:h-[250px] object-cover object-left rounded-[20px] sm:rounded-[30px]"
                      />
                    </div>

                    <!-- Contenido -->
                    <div class="p-5 sm:p-8 text-white space-y-3 sm:space-y-4">
                      <h3 class="text-xl sm:text-2xl md:text-3xl font-bold leading-tight">
                        {recipe.title}
                      </h3>

                      {recipe.description && (
                        <p class="text-white/90 text-sm sm:text-base leading-relaxed line-clamp-3">
                          {recipe.description}
                        </p>
                      )}

                      <div class="inline-flex items-center text-white font-bold text-base sm:text-lg hover:underline">
                        {currentLang === 'es' ? 'Leer más' : 'Read more'}
                      </div>
                    </div>
                  </a>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</section>

<script>
  // Script para el carrusel de recetas con auto-scroll
  document.addEventListener('DOMContentLoaded', () => {
    const carousels = document.querySelectorAll('[data-recipes-carousel]');
    
    carousels.forEach((carousel) => {
      const track = carousel.querySelector('#recipesTrack') as HTMLElement;
      if (!track) return;
      
      const slides = Array.from(track.querySelectorAll('.recipe-slide'));
      if (slides.length === 0) return;
      
      let currentIndex = 0;
      let autoScrollInterval: NodeJS.Timeout | null = null;
      
      // Función para mover al siguiente slide
      const moveToNext = () => {
        currentIndex = (currentIndex + 1) % slides.length;
        updateCarousel();
      };
      
      // Función para actualizar la posición del carrusel
      const updateCarousel = () => {
        const slideWidth = (slides[0] as HTMLElement).offsetWidth;
        const gap = 24; // 6 * 4px (gap-6 en Tailwind)
        const offset = -(currentIndex * (slideWidth + gap));
        track.style.transform = `translateX(${offset}px)`;
      };
      
      // Iniciar auto-scroll
      const startAutoScroll = () => {
        if (autoScrollInterval) clearInterval(autoScrollInterval);
        autoScrollInterval = setInterval(moveToNext, 5000); // Cambia cada 5 segundos
      };
      
      // Detener auto-scroll
      const stopAutoScroll = () => {
        if (autoScrollInterval) {
          clearInterval(autoScrollInterval);
          autoScrollInterval = null;
        }
      };
      
      // Eventos para pausar en hover
      carousel.addEventListener('mouseenter', stopAutoScroll);
      carousel.addEventListener('mouseleave', startAutoScroll);
      
      // Iniciar el auto-scroll
      startAutoScroll();
      
      // Actualizar en resize
      let resizeTimeout: NodeJS.Timeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          updateCarousel();
        }, 250);
      });
    });
  });
</script>
