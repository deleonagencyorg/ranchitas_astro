---
// src/views/Products/Detail/index.astro
import { t } from '../../../i18n/i18n';
import type { Locale } from '../../../i18n/i18n';
import './styles.css';
import { initProductDetail } from './scripts.js';
import CardQuiz from '../../../components/common/cardQuiz/index.astro';



// Interfaces locales
interface ProductSize {
  value: string;
  image: string;
}

interface Stockist {
  id: string;
  name: string;
  icon: string;
  link: string;
}

interface Product {
  id: string;
  name: string;
  image: string;
  available?: string;
  background_image: string;
  background_color: string;
  header_text_color: string;
  color_button: string;
  sizes: ProductSize[];
  description?: string;
  short_description?: string;
  presentaciones?: Array<{
    value: string;
    icono: string;
  }>;
  // relatedProducts es opcional ya que no existe en la estructura actual
  relatedProducts?: string[];
  weight?: string[];
}

const { currentLang, productId } = Astro.props;

// Obtener datos desde traducciones
const productsAssets = t('home', { namespace: 'products', locale: currentLang }) || {};
const products = t('items', { namespace: 'products', locale: currentLang as Locale }) || [];
const stockists = t('stockist', { namespace: 'products', locale: currentLang as Locale }) || [];
const product = products.find((item: Product) => item.id === productId);
const brandsAssets = t('', { namespace: 'brands', locale: currentLang }) || {};
const newsAssets =  t('', { namespace: 'news', locale: currentLang }) || {};
const brandsList = brandsAssets.brands || [];
const zibasBrand = brandsList.find((brand: any) => brand.id === 'zibas');
const cardQuizAssets = t('cardQuiz', { namespace: 'common', locale: currentLang }) || {};
const zibasProducts = (zibasBrand?.products || []).filter((product: any) => product.id !== productId);

// Si el producto no existe, lanzar error
if (!product || Object.keys(product).length === 0) {
  throw new Error(t('errors.product_not_found', { locale: currentLang }));
}

// Asegurar que todas las propiedades necesarias existan
const safeProduct: Product = {
  id: product.id || '',
  name: product.name || '',
  image: product.image || '',
  background_image: product.background_color || '',
  background_color: product.background_color || '',
  header_text_color: product.header_text_color || '#000000',
  color_button: product.color_button || '#000000',
  sizes: Array.isArray(product.sizes) ? product.sizes : [],
  available: product.available || '',
  description: product.description || '',
  weight: Array.isArray(product.weight) ? product.weight : [],
  
};

// Obtener todos los productos como un array
const productsData = t('items', { locale: currentLang, namespace: 'products' }) || [];
const allProductsArray = Array.isArray(productsData) ? productsData : [];

// Filtrar productos relacionados - simplificado para evitar errores
let relatedProducts: any[] = [];
// Solo usar productos de la misma categoría si hay más de 1 producto
if (allProductsArray.length > 1) {
  relatedProducts = allProductsArray
    .filter((p: any) => p.id !== productId)
    .slice(0, 3);
}


---

{safeProduct.background_color && (
  <article
    id="product-detail"
    class="product-detail pt-12 md:pt-29 pb-32 bg-cover bg-center relative bg-primaryCream"
    transition:animate="slide"
  >
    <div class="md:mt-[0] container mx-auto px-6 py-5 flex flex-col xl:flex-row gap-24">
      <div class="relative flex justify-center items-center w-full xl:w-[605px] p-4 xl:px-28 xl:py-8 rounded-[30px] gap-2 cursor-pointer overflow-hidden group bg-white xl:h-[593px] md:h-[593px] lg:h-[593px] h-[450px]">
        <div class="absolute inset-0 bg-black bg-opacity-0  transition-all duration-300 rounded-[85px]"></div>
        <img id="product-image" 
          class="relative z-10 xl:max-w-full xl:h-auto lg:max-w-[400px] md:max-w-[400px]" 
            src={safeProduct.image} alt={safeProduct.name} 
            transition:name={`product-image-${safeProduct.id}`} />
      </div>
      
      {/* Contenido del lado derecho */}
      <div class="w-full xl:w-1/2  h-auto">
        <h1 
          class="font-title  text-[18px] font-medium py-4 text-[#F86509]"
        >
         {currentLang === 'es' ? 'Sabor Intenso' : 'Intense flavor'}
        </h1>
        <div class="flex justify-between items-center mb-8">
          <h1 class="lg:text-6xl text-6xl font-bold italic">{safeProduct.name}</h1>
        </div>
        <h1 
          class="font-title text-[24px] font-medium py-0"
        >
          {currentLang === 'es' ? 'Tamaños disponibles:' : 'Available sizes:'}
        </h1>
        {safeProduct.weight && safeProduct.weight.length > 0 && (
          <div class="my-4 max-w-full">
            <div class="grid grid-cols-2 gap-2 md:grid-cols-6 lg:grid-cols-5 xl:grid-cols-5">
              {safeProduct.weight.map((weight, index) => (
                <div class="w-full min-w-0">
                  <button 
                    class="weight-option block w-[90.7px] h-[52px] px-4 lg:px-5 text-center rounded-[50px] border-2 border-[#F86509] text-base md:text-xl font-bold bg-white hover:bg-[#F86509] hover:text-white cursor-pointer transition-all duration-300"
                    data-weight={weight}
                    data-index={index}
                  >
                    {weight}
                  </button>
                </div>
              ))}
            </div>
          </div>
        )}
        <div class="w-full h-[58px] bg-white rounded-[15px] p-1 flex gap-1 my-8" id="product-tabs">
          <button 
            class="tab-button flex-1 h-[49px] rounded-[12px] flex items-center justify-center px-2 transition-all duration-300"
            data-tab="description"
          >
            <span class="text-[16px] font-medium leading-6">
              {currentLang === 'es' ? 'Descripción General' : 'General Description'}
            </span>
          </button>
          
          <button 
            class="tab-button flex-1 h-[49px] rounded-[12px] flex items-center justify-center px-2 transition-all duration-300"
            data-tab="nutrition"
          >
            <span class="text-[16px] font-medium leading-6">
              {currentLang === 'es' ? 'Tabla de Nutrición' : 'Nutrition Table'}
            </span>
          </button>
        </div>

        <div class="bg-white rounded-[20px] w-full">
          <p class="text-black pt-[33px] pb-[33px] pl-[33px] pr-[33px]">{safeProduct.description}</p>
        </div>

        <button class="bg-[#D61F2C] text-white rounded-[50px] w-full h-[52px] mt-[20px] text-start pl-[20px]">
          {currentLang === 'es' ? '¿Dónde comprar?' : 'Where buy?'}
        </button>
      </div>
    </div>

    <div class="hidden  xl:block absolute bottom-0 top-[809px] right-0 pointer-events-none z-20">
          <svg width="427" height="375" viewBox="0 0 427 375" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M427 0L427 374.5C416.5 322 394 261 364 243C334 225 329 219.5 312.5 209.5C285.26 188.395 254 143 239 105.5C224 68 218.5 65 205 55.5C191.5 46 94.8911 48.0193 0 0L427 0Z" fill="#FAF0D5"/>
          </svg>
    </div>
    {/* Sección de Productos Relacionados */}

  </article>
  <section class="z-30 mb-32 mt-8">
    <div class="container mx-auto px-6">
      {/* Título y subtítulo */}
      <div class="mb-12">
        <h2 class="text-5xl md:text-6xl font-bold italic mb-4">
          {currentLang === 'es' ? 'Sabores que te encantarán' : 'Flavors you will love'}
        </h2>
        <p class="text-xl md:text-2xl italic">
          {currentLang === 'es' ? 'Descubre otros sabores que también te encantarán' : 'Discover other flavors that you will also love'}
        </p>
      </div>
        {/* Grid de productos */}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {relatedProducts.slice(0, 3).map((product: any, index: number) => {
            // Colores de fondo rotativos
            return (
              <div 
              class="rounded-[30px] p-8 flex flex-col items-center justify-between xl:h-[410px] md:h-[410px] lg:h-[435px] h-[450px] transition-transform duration-300 hover:scale-105"
              style={{ backgroundColor: product.background_color }}
            >
              {/* Imagen del producto */}
              <div class="w-full flex justify-center items-center flex-1 mb-6">
                <img 
                  src={product.image} 
                  alt={product.name}
                  class="max-w-[408px] h-[235px] object-contain"
                />
              </div>
              {/* Información del producto */}
              <div class="w-full text-start">
                <h3 
                  class="text-3xl font-bold mb-2"
                  style={{ color: product.text_color }}
                >
                  {product.name}
                </h3>
                <p 
                  class="text-lg italic mb-2"
                  style={{ color: product.text_color }}
                >
                  {product.short_description }
                </p>
                <a 
                  href={`/${currentLang}/productos/${product.id}`}
                  class="inline-block rounded-full font-bold transition-all duration-300 hover:opacity-80"
                  style={{ 
                    color: product.color_button
                  }}
                >
                  {currentLang === 'es' ? 'Ver más' : 'See more'}
                </a>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  </section>
  <div class="relative z-30">
    <CardQuiz 
      cardQuiz={cardQuizAssets}
    />
  </div>
)}

<script>
  import { initProductDetail } from './scripts.js';
  
  document.addEventListener('astro:page-load', () => {
    // Inicializar producto
    initProductDetail();
    
    // Weight options
    const weightOptions = document.querySelectorAll<HTMLButtonElement>('.weight-option');
    weightOptions.forEach(option => {
      option.addEventListener('click', () => {
        weightOptions.forEach(opt => {
          opt.classList.remove('bg-[#F86509]', 'text-white');
          opt.classList.add('bg-white');
        });
        option.classList.add('bg-[#F86509]', 'text-white');
        option.classList.remove('bg-white');
        console.log('Peso seleccionado:', option.dataset.weight);
      });
    });
    weightOptions[0]?.click();
    
    // Tabs
    const tabs = document.querySelectorAll('.tab-button');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => {
          t.classList.remove('bg-[#F86509]');
          t.querySelector('span')?.classList.remove('text-white');
          t.querySelector('span')?.classList.add('text-[#0A0A0A]');
        });
        tab.classList.add('bg-[#F86509]');
        tab.querySelector('span')?.classList.add('text-white');
        tab.querySelector('span')?.classList.remove('text-[#0A0A0A]');
      });
    });
    (tabs[0] as HTMLElement)?.click();
  });
</script>
