---
// src/views/Recipes/Detail/index.astro
import './styles.css';

import LazyImage from '../../../components/common/LazyImage.astro';

import ShareModal from '../../../components/common/ShareModal.astro';
import ProductCarousel from '../../../components/recipes/ProductCarousel.astro';
import RelatedRecipesCarousel from '../../../components/recipes/RelatedRecipesCarousel.astro';
import SocialShare from '../../../components/common/SocialShare.astro';

interface RecipeItem {
  id: string;
  title: string;
  description: string;
  ingredients: string[];
  instructions: string[];
  preparation_time: number;
  servings: number;
  difficulty?: string;
  category?: string;
  image?: string;
  tags?: string[];
  product?: string | string[];
}

const { currentLang, recipeId } = Astro.props;

// Import all recipe files with static glob and filter by language
const recipeModules = import.meta.glob<{ default: RecipeItem }>("../../../locales/*/recipes/*.json");
const allRecipes: RecipeItem[] = [];
for (const path in recipeModules) {
  const lang = path.split('/')[4];
  if (lang === currentLang) {
    const mod = await recipeModules[path]();
    allRecipes.push(mod.default);
  }
}

// Find current recipe
const recipe = allRecipes.find((item: RecipeItem) => item.id === recipeId);

// Get related recipes (filter current and limit to 3)
const relatedRecipes = allRecipes
  .filter((item: RecipeItem) => item.id !== recipeId);

if (!recipe) {
  throw new Error(`Recipe with id ${recipeId} not found`);
}

// Load shared recipe assets (titles, labels etc)
const recipesAssets = {
  ingredients: currentLang === 'es' ? 'Ingredientes' : 'Ingredients',
  procedure: currentLang === 'es' ? 'Procedimiento' : 'Procedure',
  time: currentLang === 'es' ? 'Tiempo' : 'Time',
  difficulty: currentLang === 'es' ? 'Dificultad' : 'Difficulty',
  servings: currentLang === 'es' ? 'Porciones' : 'Servings',
  related_recipes: currentLang === 'es' ? 'Recetas relacionadas' : 'Related recipes'
};

// Traducir categorías
const categoryTranslations: Record<string, string> = {
  'breakfast': currentLang === 'es' ? 'Desayuno' : 'Breakfast',
  'brunch': 'Brunch',
  'lunch': currentLang === 'es' ? 'Almuerzo' : 'Lunch',
  'dinner': currentLang === 'es' ? 'Cena' : 'Dinner',
  'snack': currentLang === 'es' ? 'Snack' : 'Snack'
};

const displayCategory = recipe.category ? (categoryTranslations[recipe.category.toLowerCase()] || recipe.category) : 'Receta';

function formatTime(minutes: number): string {
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  
  if (currentLang === 'es') {
    return hours > 0 
      ? `${hours}h ${mins}min` 
      : `${mins} min`;
  } else {
    return hours > 0 
      ? `${hours}h ${mins}m` 
      : `${mins} min`;
  }
}

// Obtener slugs de productos de la receta
const productSlugs = Array.isArray(recipe.product) 
  ? recipe.product 
  : recipe.product 
    ? [recipe.product] 
    : [];

const relatedRecipesTitle = currentLang === 'es' ? 'Recetas recomendadas' : 'Recommended recipes';
---

<div class="bg-primaryCream min-h-screen">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Back button -->
    <div class="pt-8">
    <a href={`/${currentLang}/${currentLang === 'es' ? 'recetas' : 'recipes'}`} class="inline-flex items-center gap-2 text-[#F86509] hover:text-[#d55507] transition-colors">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M10.0003 15.8333L4.16699 10L10.0003 4.16667" stroke="currentColor" stroke-width="1.66667" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M15.8337 10H4.16699" stroke="currentColor" stroke-width="1.66667" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="font-medium">{currentLang === 'es' ? 'Volver a recetas' : 'Back to recipes'}</span>
    </a>
  </div>

    <!-- Main Content -->
    <section class="py-12">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-start">
      
      <!-- Left Column: Image -->
      <div class="flex flex-col gap-6">
        {recipe.image && (
          <div class="relative rounded-[2.5rem] overflow-hidden w-full aspect-square max-w-[600px]">
            <LazyImage
              src={recipe.image} 
              alt={recipe.title}
              class="w-full h-full object-cover"
              onerror="this.onerror=null;this.src='/images/recipes/placeholder.jpg';"
              transition:name={`recipe-image-${recipe.id}`}
            />
          </div>
        )}

        <!-- Social Share Buttons -->
        <div class="flex items-center justify-center gap-3">
          <button 
            onclick={`window.open('https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(Astro.url.href)}', '_blank', 'width=600,height=400')`}
            class="w-12 h-12 rounded-xl bg-[#F04F00] text-white flex items-center justify-center hover:bg-[#d54500] transition-colors" 
            aria-label="Facebook"
          >
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
              <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
            </svg>
          </button>
          <button 
            onclick={`window.open('https://twitter.com/intent/tweet?url=${encodeURIComponent(Astro.url.href)}&text=${encodeURIComponent(recipe.title)}', '_blank', 'width=600,height=400')`}
            class="w-12 h-12 rounded-xl bg-[#F04F00] text-white flex items-center justify-center hover:bg-[#d54500] transition-colors" 
            aria-label="Twitter"
          >
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
              <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
            </svg>
          </button>
          <button onclick="window.print()" class="w-12 h-12 rounded-xl bg-[#F04F00] text-white flex items-center justify-center hover:bg-[#d54500] transition-colors" aria-label="Print">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Right Column: Recipe Info -->
      <div class="flex flex-col gap-6">
        <!-- Category Badge -->
        <div>
          <span class="inline-block bg-[#F04F00] text-white px-6 py-2 rounded-full font-bold text-sm">
            {displayCategory}
          </span>
        </div>

        <!-- Title -->
        <h1 class="text-4xl md:text-5xl font-bold italic">
          {recipe.title}
        </h1>

        <!-- Description -->
        <p class="text-gray-700 text-base leading-relaxed">
          {recipe.description}
        </p>

        <!-- Info Cards -->
        <div class="grid grid-cols-3 gap-4">
          <!-- Time -->
          <div class="bg-[#F5EDD8] rounded-2xl p-6 flex flex-col items-center justify-center gap-3">
            <svg class="w-10 h-10 text-[#F04F00]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div class="text-center">
              <div class="font-bold text-xl">{formatTime(recipe.preparation_time)}</div>
              <div class="text-sm text-gray-600">{recipesAssets.time}</div>
            </div>
          </div>

          <!-- Difficulty -->
          <div class="bg-[#F5EDD8] rounded-2xl p-6 flex flex-col items-center justify-center gap-3">
            <svg width="34" height="34" viewBox="0 0 34 34" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M25.0038 31.6734C25.4458 31.6734 25.8698 31.4978 26.1823 31.1853C26.4949 30.8727 26.6705 30.4488 26.6705 30.0068V21.0901C26.6705 20.3284 27.1972 19.6834 27.8822 19.3551C29.3004 18.6785 30.4342 17.5227 31.0832 16.0916C31.7322 14.6605 31.8549 13.0461 31.4295 11.5333C31.0041 10.0206 30.0581 8.70676 28.7583 7.82366C27.4585 6.94056 25.8885 6.54499 24.3255 6.70675C23.6818 5.21043 22.6136 3.93558 21.2531 3.03981C19.8926 2.14405 18.2994 1.66666 16.6705 1.66666C15.0416 1.66666 13.4484 2.14405 12.0879 3.03981C10.7274 3.93558 9.65921 5.21043 9.01549 6.70675C7.45312 6.54612 5.88422 6.94226 4.58538 7.82531C3.28654 8.70837 2.34117 10.0216 1.91596 11.5336C1.49075 13.0455 1.613 14.6591 2.26116 16.0897C2.90932 17.5203 4.04176 18.6761 5.45882 19.3534C6.14382 19.6834 6.67049 20.3284 6.67049 21.0884V30.0068C6.67049 30.4488 6.84608 30.8727 7.15864 31.1853C7.4712 31.4978 7.89512 31.6734 8.33715 31.6734H25.0038Z" stroke="#F86509" stroke-width="3.33333" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              
            <div class="text-center">
              <div class="font-bold text-xl">{recipe.difficulty || 'Fácil'}</div>
              <div class="text-sm text-gray-600">{recipesAssets.difficulty}</div>
            </div>
          </div>

          <!-- Servings -->
          <div class="bg-[#F5EDD8] rounded-2xl p-6 flex flex-col items-center justify-center gap-3">
            <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M26.6669 3.33334L22.8336 7.16668C21.9174 8.10132 21.4043 9.35791 21.4043 10.6667C21.4043 11.9754 21.9174 13.232 22.8336 14.1667L25.8336 17.1667C26.7682 18.0828 28.0248 18.596 29.3336 18.596C30.6423 18.596 31.8989 18.0828 32.8336 17.1667L36.6669 13.3333" stroke="#F86509" stroke-width="3.33333" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M25.0004 25L5.50043 5.49997C4.83524 6.15173 4.30678 6.92967 3.94601 7.78822C3.58524 8.64678 3.39941 9.56869 3.39941 10.5C3.39941 11.4312 3.58524 12.3532 3.94601 13.2117C4.30678 14.0703 4.83524 14.8482 5.50043 15.5L17.6671 27.6666C18.8338 28.8333 21.0004 28.8333 22.3338 27.6666L25.0004 25ZM25.0004 25L36.6671 36.6666" stroke="#F86509" stroke-width="3.33333" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M3.5 36.3333L14.1667 25.8333" stroke="#F86509" stroke-width="3.33333" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M31.6667 8.33334L20 20" stroke="#F86509" stroke-width="3.33333" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              
            <div class="text-center">
              <div class="font-bold text-xl">{recipe.servings}</div>
              <div class="text-sm text-gray-600">{recipesAssets.servings}</div>
            </div>
          </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-2">
          <button 
            id="ingredientsTab"
            class="flex-1 py-3 px-6 rounded-full font-bold transition-colors bg-[#F04F00] text-white"
            onclick="showTab('ingredients')"
          >
            {recipesAssets.ingredients}
          </button>
          <button 
            id="procedureTab"
            class="flex-1 py-3 px-6 rounded-full font-bold transition-colors bg-[#F5EDD8] text-gray-700"
            onclick="showTab('procedure')"
          >
            {recipesAssets.procedure}
          </button>
        </div>

        <!-- Tab Content -->
        <div id="ingredientsContent" class="bg-[#F04F00] rounded-2xl p-8">
          <ul class="space-y-4 text-white">
            {recipe.ingredients.map((ingredient: string) => (
              <li class="flex items-start gap-3">
                <span class="w-2 h-2 rounded-full bg-white mt-2 flex-shrink-0"></span>
                <span class="text-base">{ingredient}</span>
              </li>
            ))}
          </ul>
        </div>

        <div id="procedureContent" class="hidden bg-[#F5EDD8] rounded-2xl p-8">
          <ol class="space-y-4 text-gray-800 list-decimal list-inside">
            {recipe.instructions.map((instruction: string, index: number) => (
              <li class="text-base leading-relaxed">
                {instruction}
              </li>
            ))}
          </ol>
        </div>
      </div>
    </div>
    </section>

    <!-- Product Carousel Section -->
    {productSlugs.length > 0 && (
      <section class="py-12">
        <ProductCarousel 
          productSlugs={productSlugs}
          currentLang={currentLang}
        />
      </section>
    )}

    <!-- Related Recipes Section -->
    {relatedRecipes.length > 0 && (
      <section class="py-12">
        <div class="mb-8">
          <h2 class="text-3xl md:text-4xl font-bold text-black text-center">
            {relatedRecipesTitle}
          </h2>
        </div>
        <RelatedRecipesCarousel items={relatedRecipes} />
      </section>
    )}
  </div>
</div>

<script>
  // Tab functionality
  function showTab(tabName: string) {
    const ingredientsTab = document.getElementById('ingredientsTab');
    const procedureTab = document.getElementById('procedureTab');
    const ingredientsContent = document.getElementById('ingredientsContent');
    const procedureContent = document.getElementById('procedureContent');

    if (tabName === 'ingredients') {
      ingredientsTab?.classList.add('bg-[#F04F00]', 'text-white');
      ingredientsTab?.classList.remove('bg-[#F5EDD8]', 'text-gray-700');
      procedureTab?.classList.add('bg-[#F5EDD8]', 'text-gray-700');
      procedureTab?.classList.remove('bg-[#F04F00]', 'text-white');
      ingredientsContent?.classList.remove('hidden');
      procedureContent?.classList.add('hidden');
    } else {
      procedureTab?.classList.add('bg-[#F04F00]', 'text-white');
      procedureTab?.classList.remove('bg-[#F5EDD8]', 'text-gray-700');
      ingredientsTab?.classList.add('bg-[#F5EDD8]', 'text-gray-700');
      ingredientsTab?.classList.remove('bg-[#F04F00]', 'text-white');
      procedureContent?.classList.remove('hidden');
      ingredientsContent?.classList.add('hidden');
    }
  }

  // Make function available globally
  (window as any).showTab = showTab;

  // Image error handling
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('img').forEach(img => {
      if (!img.hasAttribute('onerror')) {
        img.addEventListener('error', function(this: HTMLImageElement) {
          this.onerror = null;
          this.src = '/images/recipes/placeholder.jpg';
        });
      }
    });
  });
</script>

<!-- Share Modal instance -->
<ShareModal
  id="shareModal-recipe"
  url={Astro.url.href}
  title={recipe.title}
  description={recipe.description}
  hashtags={recipe.tags || []}
  showLabels={false}
  iconSize={40}
  round={true}
  openTextEs="Comparte esta receta en tus redes sociales"
  openTextEn="Share this recipe on your social networks"
  acceptTextEs="Aceptar"
  acceptTextEn="Accept"
/>