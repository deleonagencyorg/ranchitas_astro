---
// src/views/Recipes/index.astro
import { getLocale } from '../../i18n/i18n';
import './styles.css';
import RecipeCardLarge from '../../components/recipes/RecipeCardLarge.astro';
import RecipeCardSmall from '../../components/recipes/RecipeCardSmall.astro';
import RecipeCard from '../../components/recipes/RecipeCard.astro';

interface Recipe {
  id: string;
  title: string;
  image?: string;
  preparation_time: number;
  type?: string;
  category?: string;
  product?: string | string[];
  difficulty?: string;
}

const currentLang = getLocale();

// Get all recipe files with correct Vite glob typing
const recipeModules = import.meta.glob<{default: Recipe}>('../../locales/*/recipes/*.json');
const allRecipes: Recipe[] = [];

// Process each file
for (const path in recipeModules) {
  const lang = path.split('/')[3];
  if (lang === currentLang) {
    const module = await recipeModules[path]();
    allRecipes.push(module.default);
  }
}

// Shared translations
const noRecipesText = currentLang === 'es' 
  ? 'No hay recetas disponibles en este momento.' 
  : 'No recipes available at this time.';
const noFilterResultsText = currentLang === 'es'
  ? 'No se encontraron resultados para la selección'
  : 'No results found for the selection';
const loadMoreText = currentLang === 'es' ? 'Cargar más' : 'Load more';

// Filter labels
const filterLabels = currentLang === 'es'
  ? { 
      typeLabel: 'Tipo',
      productLabel: 'Producto',
      searchPlaceholder: 'Buscar producto...',
      all: 'Todos',
      breakfast: 'Desayuno', 
      brunch: 'Brunch',
      lunch: 'Almuerzo',
      dinner: 'Cena',
      snack: 'Snack'
    }
  : {
      typeLabel: 'Type',
      productLabel: 'Product',
      searchPlaceholder: 'Search product...',
      all: 'All',
      breakfast: 'Breakfast',
      brunch: 'Brunch',
      lunch: 'Lunch',
      dinner: 'Dinner',
      snack: 'Snack'
    };

// Normaliza la categoría de receta
function normalizeType(r: Recipe): string {
  const rawCategory = String((r as any).category || '').toLowerCase().trim();
  
  // Mapeo directo de categorías válidas
  const categoryMap: Record<string, string> = {
    'breakfast': 'breakfast',
    'brunch': 'brunch', 
    'lunch': 'lunch',
    'dinner': 'dinner',
    'snack': 'snack'
  };
  
  return categoryMap[rawCategory] || 'other';
}

// Obtener categorías únicas disponibles
const uniqueCategories = [...new Set(allRecipes.map(r => normalizeType(r)).filter(cat => cat !== 'other'))];

// Cargar catálogo de productos desde locales por idioma actual
interface ProductItem { id: string; name: string; description?: string; }
const productModules = import.meta.glob<{ default: { items: ProductItem[] } }>('../../locales/*/products.json');
const productMap: Record<string, ProductItem> = {};

for (const path in productModules) {
  const lang = path.split('/')[3];
  if (lang === currentLang) {
    const mod = await productModules[path]();
    for (const item of (mod.default.items || [])) {
      productMap[item.id] = item;
    }
  }
}

// Opciones de productos para el selector: tomar TODOS los productos del catálogo del idioma actual
const uniqueProducts = Object.keys(productMap);

// Dividir recetas: primera destacada, siguientes 3 en sidebar, resto en grid
const featuredRecipe = allRecipes[0];
const sidebarRecipes = allRecipes.slice(1, 4);
const gridRecipes = allRecipes.slice(4);
---

<div class="overflow-hidden bg-primaryCream">
  
  <div class="container ml-4 sm:ml-6 md:ml-[40px] mt-6 sm:mt-8 md:mt-[40px] mr-4 sm:mr-6 md:mr-[40px] mb-12 sm:mb-16 md:mb-20">

    <!-- Header -->
    <div class="mb-3 sm:mb-4">
      <h1 class="text-[36px] sm:text-[48px] md:text-[64px] font-bold leading-tight">
        {currentLang==='es' ? 'Recetas' : 'Recipes'}
        <span class="text-orange">{currentLang==='es' ? 'Ranchitas' : 'Ranchitas'}</span>
      </h1>
    </div>
    
    <div class="mb-6 sm:mb-8">
      <p class="text-sm sm:text-base md:text-[18px]">
        {currentLang==='es' 
          ? 'Descubre formas deliciosas y creativas de disfrutar tus Ranchitas favoritas. Desde snacks rápidos hasta platos principales.' 
          : 'Discover delicious and creative ways to enjoy your favorite Ranchitas. From quick snacks to main dishes.'}
      </p>
    </div>

    <!-- Filter Section -->
    <div class="flex flex-col md:flex-row gap-3 sm:gap-4 mb-8 sm:mb-12">
      <!-- Tipo Filter -->
      <div class="relative">
        <select 
          id="typeFilter" 
          class="appearance-none bg-white rounded-full w-full px-4 sm:px-6 py-2 sm:py-3 pr-10 text-sm sm:text-base font-medium border-0 shadow-sm cursor-pointer hover:shadow-md transition-shadow focus:outline-none focus:ring-2 focus:ring-orange"
        >
          <option value="all">{filterLabels.typeLabel}: {filterLabels.all}</option>
          {uniqueCategories.includes('breakfast') && <option value="breakfast">{filterLabels.typeLabel}: {filterLabels.breakfast}</option>}
          {uniqueCategories.includes('brunch') && <option value="brunch">{filterLabels.typeLabel}: {filterLabels.brunch}</option>}
          {uniqueCategories.includes('lunch') && <option value="lunch">{filterLabels.typeLabel}: {filterLabels.lunch}</option>}
          {uniqueCategories.includes('dinner') && <option value="dinner">{filterLabels.typeLabel}: {filterLabels.dinner}</option>}
          {uniqueCategories.includes('snack') && <option value="snack">{filterLabels.typeLabel}: {filterLabels.snack}</option>}
        </select>
        <svg class="hidden md:block absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 pointer-events-none" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
      </div>

      <!-- Producto Filter -->
      <div class="relative">
        <select 
          id="productFilter" 
          class="appearance-none bg-white rounded-full w-full px-4 sm:px-6 py-2 sm:py-3 pr-10 text-sm sm:text-base font-medium border-0 shadow-sm cursor-pointer hover:shadow-md transition-shadow focus:outline-none focus:ring-2 focus:ring-orange"
        >
          <option value="all">{filterLabels.productLabel}: {filterLabels.all}</option>
          {uniqueProducts.map(productId => (
            <option value={productId}>{filterLabels.productLabel}: {productMap[productId]?.name || productId}</option>
          ))}
        </select>
        <svg class="hidden md:block absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 pointer-events-none" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
      </div>

      <!-- Product info (shown when a product is selected) -->
      <div id="productInfo" class="hidden flex-1 bg-white rounded-xl px-4 sm:px-6 py-3 sm:py-4 border border-gray-100 shadow-sm">
        <!-- content set by script based on selected product -->
      </div>

      
    </div>

    <h2 id="featuredTitle" class="text-[28px] sm:text-[36px] md:text-[42px] font-bold mb-6 sm:mb-8">
      {currentLang==='es' ? 'Las más populares del momento' : 'The most popular ones right now'}
    </h2>

    {allRecipes.length === 0 ? (
      <p class="text-center text-gray-500">{noRecipesText}</p>
    ) : (
      <>
        <div id="featuredSection" class="grid grid-cols-1 lg:grid-cols-12 gap-4 sm:gap-6 mb-12 sm:mb-16">
          {featuredRecipe && (
            <div 
              class="lg:col-span-8 recipe-card" 
              data-type={normalizeType(featuredRecipe)}
              data-products={(Array.isArray(featuredRecipe.product) ? featuredRecipe.product : (featuredRecipe.product ? [featuredRecipe.product] : [])).join(',')}
              data-title={featuredRecipe.title.toLowerCase()}
            >
              <RecipeCardLarge
                image={featuredRecipe.image || '/images/recipes/placeholder.jpg'}
                title={featuredRecipe.title}
                time={`${featuredRecipe.preparation_time} min`}
                id={featuredRecipe.id}
                difficulty={featuredRecipe.difficulty || (currentLang === 'es' ? 'Fácil' : 'Easy')}
                product={Array.isArray(featuredRecipe.product) ? featuredRecipe.product[0] : featuredRecipe.product}
                category={normalizeType(featuredRecipe)}
              />
            </div>
          )}
          
          <div class="lg:col-span-4 flex flex-col gap-4 justify-between">
            {sidebarRecipes.map((recipe: Recipe) => (
              <div 
                class="recipe-card" 
                data-type={normalizeType(recipe)}
                data-products={(Array.isArray(recipe.product) ? recipe.product : (recipe.product ? [recipe.product] : [])).join(',')}
                data-title={recipe.title.toLowerCase()}
              >
                <RecipeCardSmall
                  image={recipe.image || '/images/recipes/placeholder.jpg'}
                  title={recipe.title}
                  id={recipe.id}
                  product={Array.isArray(recipe.product) ? recipe.product[0] : recipe.product}
                  category={normalizeType(recipe)}
                />
              </div>
            ))}
          </div>
        </div>
        <!-- No results message -->
        <div id="noResults" class="hidden mt-12 items-center justify-center h-48">
          <p class="text-gray-500 text-lg font-medium">{noFilterResultsText}</p>
        </div>
      </>
    )}

  <h2 class="text-[42px] font-bold mb-8">{currentLang === 'es' ? 'Descubre más recetas' : 'Discover more recipes' }</h2>
  {allRecipes.length === 0 ? (
    <p class="text-center text-gray-500">{noRecipesText}</p>
  ) : (
    <div id="recipesGrid" class="w-full mx-auto grid grid-cols-1 sm:grid-cols-2 gap-6 md:gap-10 mt-12">
      {allRecipes.map((recipe: Recipe) => (
        <div class="recipe-card recipe-grid-card h-full" 
             data-type={normalizeType(recipe)}
             data-products={(Array.isArray(recipe.product) ? recipe.product : (recipe.product ? [recipe.product] : [])).join(',')}
             data-title={recipe.title.toLowerCase()}>
          <RecipeCard
            image={recipe.image || '/images/recipes/placeholder.jpg'}
            title={recipe.title}
            time={`${recipe.preparation_time}MIN`}
            id={recipe.id}
            textColor="text-white"
            iconColor="text-white"
            product={Array.isArray(recipe.product) ? recipe.product[0] : recipe.product}
          />
        </div>
      ))}
    </div>

    <div class="flex justify-center mt-10">
      <button
        id="recipesLoadMore"
        type="button"
        class="bg-orange hover:bg-orange/90 text-white font-bold py-3 px-10 rounded-full transition-all duration-200 text-lg"
      >
        {loadMoreText}
      </button>
    </div>
    <!-- No results message for filters -->
    <div id="noResultsGrid" class="hidden mt-6 items-center justify-center h-48 md:h-64">
      <span class="text-[#D61F2C] text-lg md:text-xl font-semibold">{noFilterResultsText}</span>
    </div>
    <!-- Infinite scroll sentinel -->
    <div id="infiniteSentinel" class="w-full h-10"></div>
  )}
  </div>
  
</div>

<!-- Serialized product map for client-side consumption -->
<script type="application/json" id="product-map">{JSON.stringify(productMap)}</script>

<script is:inline>
  // REINGENIERÍA DEL SISTEMA DE FILTRADO CON ANIMACIONES FLUIDAS Y PERSISTENCIA
  (function() {
    'use strict';
    
    const STORAGE_KEY = 'recipeFilters';
    
    // Parse product map
    let PRODUCT_MAP = {};
    try {
      const mapEl = document.getElementById('product-map');
      if (mapEl && mapEl.textContent) {
        PRODUCT_MAP = JSON.parse(mapEl.textContent);
      }
    } catch(e) {
      console.error('Error parsing product map:', e);
    }

    // Guardar filtros en sessionStorage
    function saveFilters(typeValue, productValue) {
      try {
        sessionStorage.setItem(STORAGE_KEY, JSON.stringify({
          type: typeValue,
          product: productValue
        }));
      } catch(e) {
        console.error('Error saving filters:', e);
      }
    }

    // Cargar filtros desde sessionStorage
    function loadFilters() {
      try {
        const saved = sessionStorage.getItem(STORAGE_KEY);
        if (saved) {
          return JSON.parse(saved);
        }
      } catch(e) {
        console.error('Error loading filters:', e);
      }
      return null;
    }

    // Restaurar valores de los filtros
    function restoreFilters() {
      const saved = loadFilters();
      if (saved) {
        const typeFilter = document.getElementById('typeFilter');
        const productFilter = document.getElementById('productFilter');
        
        if (typeFilter && saved.type) {
          typeFilter.value = saved.type;
        }
        if (productFilter && saved.product) {
          productFilter.value = saved.product;
        }
        
        // Aplicar filtros si hay valores guardados
        if (saved.type !== 'all' || saved.product !== 'all') {
          setTimeout(() => applyFilters(), 100);
        }
      }
    }

    function applyFilters() {
      // Get filter elements
      const typeFilter = document.getElementById('typeFilter');
      const productFilter = document.getElementById('productFilter');
      const productInfo = document.getElementById('productInfo');
      const featuredTitle = document.getElementById('featuredTitle');
      const featuredSection = document.getElementById('featuredSection');
      const recipesGrid = document.getElementById('recipesGrid');
      const noResults = document.getElementById('noResults');
      const noResultsGrid = document.getElementById('noResultsGrid');
      
      if (!typeFilter || !productFilter) {
        console.warn('Filters not found, retrying...');
        return;
      }

      // Get current filter values
      const typeValue = typeFilter.value || 'all';
      const productValue = productFilter.value || 'all';

      // Guardar filtros en sessionStorage
      saveFilters(typeValue, productValue);

      // Detectar si hay filtros activos
      const hasActiveFilters = typeValue !== 'all' || productValue !== 'all';

      // Get all recipe cards
      const recipeCards = document.querySelectorAll('.recipe-card');
      const visibleCards = [];
      const hiddenCards = [];

      // Apply filters to each card
      recipeCards.forEach(function(card) {
        const cardType = card.getAttribute('data-type') || '';
        const cardProductsStr = card.getAttribute('data-products') || '';
        const cardProducts = cardProductsStr.split(',').filter(function(p) { return p.trim() !== ''; });

        // Check if card matches filters
        const matchesType = typeValue === 'all' || cardType === typeValue;
        const matchesProduct = productValue === 'all' || cardProducts.indexOf(productValue) !== -1;
        const isVisible = matchesType && matchesProduct;

        if (isVisible) {
          visibleCards.push(card);
        } else {
          hiddenCards.push(card);
        }
      });

      // Aplicar animaciones fluidas usando la función global
      if (typeof window.animateRecipeFilters === 'function') {
        window.animateRecipeFilters(visibleCards, hiddenCards);
      } else {
        // Fallback sin animaciones
        visibleCards.forEach(card => {
          card.style.display = '';
          card.classList.add('visible');
        });
        hiddenCards.forEach(card => {
          card.style.display = 'none';
        });
      }

      // Show/hide sections based on filters and results
      const hasResults = visibleCards.length > 0;
      
      // Si hay filtros activos, ocultar la sección "Las más populares" y su título con transición
      if (featuredTitle) {
        if (hasActiveFilters) {
          featuredTitle.style.opacity = '0';
          featuredTitle.style.transform = 'translateY(-10px)';
          setTimeout(() => {
            featuredTitle.style.display = 'none';
          }, 300);
        } else {
          featuredTitle.style.display = '';
          requestAnimationFrame(() => {
            featuredTitle.style.opacity = '1';
            featuredTitle.style.transform = 'translateY(0)';
          });
        }
      }
      
      if (featuredSection) {
        if (hasActiveFilters) {
          featuredSection.classList.add('section-hide');
          setTimeout(() => {
            featuredSection.style.display = 'none';
          }, 400);
        } else {
          featuredSection.style.display = '';
          requestAnimationFrame(() => {
            featuredSection.classList.remove('section-hide');
          });
        }
      }
      
      // El grid con transición suave
      if (recipesGrid) {
        if (hasResults) {
          recipesGrid.style.display = '';
          requestAnimationFrame(() => {
            recipesGrid.classList.remove('section-hide');
          });
        } else {
          recipesGrid.classList.add('section-hide');
          setTimeout(() => {
            recipesGrid.style.display = 'none';
          }, 400);
        }
      }
      
      // Handle no results messages con animaciones
      if (noResults) {
        if (!hasActiveFilters && !hasResults) {
          noResults.classList.remove('hidden');
          noResults.classList.add('flex', 'show');
        } else {
          noResults.classList.remove('show');
          setTimeout(() => {
            noResults.classList.add('hidden');
            noResults.classList.remove('flex');
          }, 300);
        }
      }
      
      if (noResultsGrid) {
        if (!hasResults) {
          noResultsGrid.classList.remove('hidden');
          noResultsGrid.classList.add('flex', 'show');
        } else {
          noResultsGrid.classList.remove('show');
          setTimeout(() => {
            noResultsGrid.classList.add('hidden');
            noResultsGrid.classList.remove('flex');
          }, 300);
        }
      }

      // Update product info panel con transición
      if (productInfo) {
        const selected = productValue !== 'all' ? PRODUCT_MAP[productValue] : null;
        if (selected) {
          const title = selected.name || productValue;
          const desc = selected.description || '';
          productInfo.innerHTML = '<div class="flex flex-col gap-1"><div class="text-base font-semibold text-gray-900">' + title + '</div>' + (desc ? '<div class="text-sm text-gray-600">' + desc + '</div>' : '') + '</div>';
          productInfo.style.opacity = '0';
          productInfo.classList.remove('hidden');
          productInfo.classList.add('flex');
          requestAnimationFrame(() => {
            productInfo.style.transition = 'opacity 0.3s ease';
            productInfo.style.opacity = '1';
          });
        } else {
          productInfo.style.opacity = '0';
          setTimeout(() => {
            productInfo.classList.add('hidden');
            productInfo.classList.remove('flex');
            productInfo.innerHTML = '';
          }, 300);
        }
      }
    }

    // Attach event listeners
    function attachListeners() {
      const typeFilter = document.getElementById('typeFilter');
      const productFilter = document.getElementById('productFilter');
      
      if (typeFilter && productFilter) {
        // Remover listeners previos para evitar duplicados
        typeFilter.removeEventListener('change', applyFilters);
        productFilter.removeEventListener('change', applyFilters);
        
        // Agregar nuevos listeners
        typeFilter.addEventListener('change', applyFilters);
        productFilter.addEventListener('change', applyFilters);
      }
    }

    // Initialize
    function init() {
      attachListeners();
      // Restaurar filtros guardados
      restoreFilters();
    }

    // Try to run immediately
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
    
    // Re-inicializar después de navegaciones de Astro
    document.addEventListener('astro:page-load', init);
  })();
</script>

<script is:inline>
  (function() {
    'use strict';

    const INITIAL = 6;
    const STEP = 6;

    function getGridCards() {
      return Array.from(document.querySelectorAll('.recipe-grid-card'));
    }

    function getVisibleGridCards(cards) {
      return cards.filter((el) => {
        if (!(el instanceof HTMLElement)) return false;
        return el.style.display !== 'none';
      });
    }

    function applyLoadMore(reset) {
      const button = document.getElementById('recipesLoadMore');
      const cards = getGridCards();
      if (!button || cards.length === 0) return;

      const visibleCards = getVisibleGridCards(cards);

      let shown = Number(button.getAttribute('data-shown') || '0');
      if (reset || shown === 0) shown = Math.min(INITIAL, visibleCards.length);

      visibleCards.forEach((card, idx) => {
        if (!(card instanceof HTMLElement)) return;
        if (idx < shown) {
          card.classList.remove('hidden');
        } else {
          card.classList.add('hidden');
        }
      });

      button.setAttribute('data-shown', String(shown));

      if (visibleCards.length <= shown) {
        button.classList.add('hidden');
      } else {
        button.classList.remove('hidden');
      }
    }

    function initRecipesLoadMore() {
      const button = document.getElementById('recipesLoadMore');
      if (!button) return;

      applyLoadMore(true);

      button.addEventListener('click', (e) => {
        e.preventDefault();
        const cards = getVisibleGridCards(getGridCards());
        const current = Number(button.getAttribute('data-shown') || String(INITIAL));
        const next = Math.min(current + STEP, cards.length);
        button.setAttribute('data-shown', String(next));
        applyLoadMore(false);
      });

      const typeFilter = document.getElementById('typeFilter');
      const productFilter = document.getElementById('productFilter');
      const onFilterChange = () => setTimeout(() => applyLoadMore(true), 0);
      if (typeFilter) typeFilter.addEventListener('change', onFilterChange);
      if (productFilter) productFilter.addEventListener('change', onFilterChange);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initRecipesLoadMore);
    } else {
      initRecipesLoadMore();
    }
    document.addEventListener('astro:page-load', initRecipesLoadMore);
  })();
</script>

<style>
  select {
    background-image: none;
  }
  
  select:hover, input:hover {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Transiciones suaves para títulos y secciones */
  #featuredTitle {
    transition: opacity 0.3s ease, transform 0.3s ease;
  }

  #productInfo {
    transition: opacity 0.3s ease;
  }
</style>