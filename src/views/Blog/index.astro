---
// src/views/Blog/index.astro
import { type Locale } from '../../i18n/i18n';
import { ViewTransitions } from 'astro:transitions';
import MainLayout from '../../layouts/MainLayout.astro';
import './styles.css';
import BlogCard from '../../components/blog/BlogCard.astro';
import Breadcrumb from '../../components/common/Breadcrumb/Breadcrumb.astro';
import NewsCarousel from '../../components/blog/NewsCarousel.astro';
import { getCategoryName } from '../../i18n/categories';

export interface Props { currentLang: Locale }

interface BlogPostFrontmatter {
  id: string;
  slug: string;
  title: string;
  summary?: string;
  image?: string;
  published_date?: string;
  category?: string;
}

const { currentLang } = Astro.props;
const pageTitle = currentLang === 'es' ? 'Noticias' : 'News';
const pageDescription = currentLang === 'es' 
  ? 'Mantente al día con nuestras últimas noticias y artículos.' 
  : 'Stay updated with our latest news and articles.';

const sectionKicker = currentLang === 'es' ? 'Noticias Ranchitas' : 'Ranchitas News';
const heroTitle = currentLang === 'es' ? 'Historias, novedades y todo sobre el ' : 'Stories, news and everything about the ';
const heroHighlight = currentLang === 'es' ? 'crunch perfecto' : 'perfect crunch';
const heroSubtitle = currentLang === 'es'
  ? 'Descubre el mundo detrás de tus snacks favoritos.'
  : 'Discover the world behind your favorite snacks.';
const emailPlaceholder = currentLang === 'es' ? 'Ingresa tu correo electrónico' : 'Enter your email address';
const subscribeText = currentLang === 'es' ? 'Suscribirme' : 'Subscribe';
const loadMoreText = currentLang === 'es' ? 'Cargar más' : 'Load more';

// Load markdown posts for the current language
const mdModules = import.meta.glob('../../locales/*/blog/*.md');
let allPosts: BlogPostFrontmatter[] = [];

for (const path in mdModules) {
  const lang = path.split('/')[3];
  if (lang === currentLang) {
    const mod: any = await mdModules[path]();
    const fm = mod.frontmatter || {};
    if (fm && fm.id && fm.slug && fm.title) {
      allPosts.push({
        id: String(fm.id),
        slug: String(fm.slug),
        title: String(fm.title),
        summary: fm.summary ? String(fm.summary) : '',
        image: fm.image ? String(fm.image) : '/images/blog/placeholder.jpg',
        published_date: fm.published_date ? String(fm.published_date) : '',
        category: fm.category ? String(fm.category).toLowerCase() : 'other'
      });
    }
  }
}

// Sort by published_date desc (ISO or fallback)
function toDate(s: string | undefined): number {
  if (!s) return 0;
  // normalize common formats dd/mm/yyyy or yyyy-mm-dd
  if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)) {
    const [d,m,y] = s.split('/').map(Number);
    return new Date(y, (m||1)-1, d||1).getTime();
  }
  const t = Date.parse(s);
  return isNaN(t) ? 0 : t;
}
allPosts = allPosts.sort((a,b) => toDate(b.published_date) - toDate(a.published_date));

// Build dynamic categories set
const categories = Array.from(new Set(allPosts.map(p => (p.category || 'other'))));

const filterLabels = currentLang === 'es'
  ? { all: 'TODAS' }
  : { all: 'ALL' };

const noPostsText = currentLang === 'es'
  ? 'No hay noticias disponibles en este momento.'
  : 'No blog posts available at this time.';

// Labels and splits for the two-column layout below
const topNewsLabel = currentLang === 'es' ? 'NOTICIAS MÁS IMPORTANTES' : 'TOP NEWS';
const featuredLabel = currentLang === 'es' ? 'DESTACADOS' : 'FEATURED';
const firstFive = allPosts.slice(0, 5);
const leftThree = firstFive.slice(0, 3);
const rightTwo = firstFive.slice(3, 5);
const restPosts = allPosts.slice(5);
---
<MainLayout title={pageTitle} description={pageDescription} class="bg-primaryCream">
  <ViewTransitions />
  <div class="container mx-auto px-4">
    <div class="max-w-7xl mx-auto mt-[20px] mb-20">

      <div class="pt-2">
        <Breadcrumb bgColor="bg-transparent" textColor="text-black" hoverColor="hover:text-black" />
      </div>

      <!-- Header (match Recipes style + provided design) -->
      <div class="text-left md:text-center mb-4">
        <div class="text-orange font-bold mb-4">
          {sectionKicker}
        </div>
        <h1 class="text-black font-title font-bold italic leading-tight text-[44px] md:text-[72px] max-w-5xl mx-auto">
          {heroTitle}
          <span class="text-orange font-heading ">{heroHighlight}</span>
        </h1>
       
      </div>
      <div class="text-left md:text-center my-8 flex flex-col gap-4 md:gap-6">
         <p class="text-black/70 max-w-2xl mx-auto">
          {heroSubtitle}
        </p>
          <a 
            href="https://www.snacksyummies.com/es/yummiesone" 
            target="_blank" 
            rel="noopener noreferrer"
            class="bg-orange hover:bg-orange/90 text-white font-bold rounded-full transition-all duration-200 text-lg w-full max-w-[341px] h-[54px] inline-flex items-center justify-center mx-auto md:w-[200px] md:max-w-none"
          >
            {currentLang === 'es' ? 'Suscribirme' : 'Subscribe'}
          </a>
      </div>

      {allPosts.length === 0 ? (
        <div class="max-w-5xl mx-auto text-center py-12">
          <p class="text-black text-lg md:text-xl font-semibold">{noPostsText}</p>
        </div>
      ) : (
        <>
       

          <div class="max-w-7xl mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-10">
              {allPosts.map((post, index) => (
                <div class={`news-card ${index >= 6 ? 'hidden' : ''}`} data-category={(post.category || 'other').toLowerCase()} data-news-index={index}>
                  <BlogCard
                    image={post.image || '/images/blog/placeholder.jpg'}
                    title={post.title}
                    summary={post.summary || ''}
                    published_date={post.published_date || ''}
                    id={post.id}
                    slug={post.slug}
                    currentLang={currentLang}
                  />
                </div>
              ))}
            </div>

            <div class="flex justify-center mt-10">
              <button
                id="blogLoadMore"
                type="button"
                class="bg-orange hover:bg-orange/90 text-white font-bold py-3 px-10 rounded-full transition-all duration-200 text-lg"
                data-load-more
              >
                {loadMoreText}
              </button>
            </div>
          </div>
        </>
      )}
    </div>
  </div>
</MainLayout>

<style>
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

<script>
  function initBlogLoadMore() {
    const INITIAL = 6;
    const STEP = 6;

    const cards = Array.from(document.querySelectorAll('[data-news-index]'));
    const button = document.getElementById('blogLoadMore');

    if (!button) return;

    let visible = cards.filter((c) => !c.classList.contains('hidden')).length;
    if (visible === 0 && cards.length > 0) {
      cards.slice(0, INITIAL).forEach((c) => c.classList.remove('hidden'));
      visible = Math.min(INITIAL, cards.length);
    }

    const update = () => {
      if (visible >= cards.length) {
        button.classList.add('hidden');
      } else {
        button.classList.remove('hidden');
      }
    };

    update();

    button.addEventListener('click', (e) => {
      e.preventDefault();
      const next = Math.min(visible + STEP, cards.length);
      cards.slice(visible, next).forEach((c) => c.classList.remove('hidden'));
      visible = next;
      update();
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initBlogLoadMore);
  } else {
    initBlogLoadMore();
  }
  document.addEventListener('astro:page-load', initBlogLoadMore);
</script>
